z_vccbdp01:--z_vccbdp01
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 	
	declare @t_path nvarchar(max) = '[1]'
	declare @t_db nvarchar(max) = '[2]'
	declare @t_bno nvarchar(max) = case when '#non' = [3] then '' else [3] end
	declare @t_eno nvarchar(max) = case when '#non' = [4] then '' else [4] end
	declare @t_stype nvarchar(30)  = case when '#non' = [5] then '' else [5] end
	declare @t_showtype nvarchar(10) = case when '#non' = [6] then '' else [6] end
	declare @t_showprice nvarchar(10)  = case when '#non' = [7] then '' else [7] end
	declare @t_merga nvarchar(10)  = case when '#non' = [8] then '' else [8] end 
	----------------------------------------------------------------------------------------------
	declare @t_pageline int = 6 --------一頁幾行 

	declare @tmp table(
		gno nvarchar(1),
		idno int identity(0,1),
		cno nvarchar(20),
		acomp nvarchar(50),
		aaddr nvarchar(max),
		atel nvarchar(max),
		afax nvarchar(max),

		orderno int,
		pageno int,
		kind nvarchar(15),
		stype nvarchar(30),
		noa nvarchar(50),
		typea nvarchar(10),
		datea nvarchar(20),
		custno nvarchar(30),
		custs nvarchar(90),
		tel nvarchar(90),
		addr nvarchar(max),
		cardeal nvarchar(50),
		carno nvarchar(50),
		memo nvarchar(max),
		money float,
		tax float,
		total float,
		ordeno nvarchar(35),
		uno nvarchar(50),
		spec nvarchar(max),
		products nvarchar(max),
		csize nvarchar(max),
		mount float,
		weight float, 
		price float,
		trantype nvarchar(30)
	
	)
	declare @checkUcca int = (select count(*) from ucca)
	if(@t_merga = '0')
	begin
		insert into @tmp
			select '0' gno, ROW_NUMBER()over(partition by a.noa order by a.noa) idno
				,a.cno cno,e.acomp acomp,e.addr aaddr,e.tel atel,e.fax afax
				,1 ordeno,a.kind,a.stype,a.noa,a.typea,a.datea,a.custno,a.comp,a.tel,(case when a.addr2!='' then a.post2+a.addr2 else a.post+a.addr end),a.cardeal,a.carno,a.memo,
				a.money,
				case when @checkUcca>0 then 0 else isnull(a.tax,0) end,
				a.total,b.ordeno+(case when isnull(d.itype,'')='3' then '寄庫' else '' end),b.uno,b.spec,
				case when charindex(left(uno,1),'XYZ') > 0 then (case when len(b.product)>0 then b.product else '廢料' end) else b.product end,
				(case when (b.style='' and b.dime='') then null else 
					(case @t_showtype when '1' then b.size when '2' then dbo.csize(a.kind,b.dime,b.width,b.lengthb,b.radius) else
					(case when ltrim(rtrim(isnull(b.size,'')))='' then dbo.csize(a.kind,b.dime,b.width,b.lengthb,b.radius) else b.size end) end )
				end) size,
				(case when ((b.style='' and b.dime='') and charindex(left(b.uno,1),'XYZ') <= 0 ) then null else b.mount end),
				(case when ((b.style='' and b.dime='') and charindex(left(b.uno,1),'XYZ') <= 0) then null else b.weight end),
				b.price,a.trantype
			from view_vcc a
			left join view_vccs b on a.accy=b.accy and a.noa = b.noa
			left join vcca c on a.invono=c.noa
			outer apply(
				select
					top 1 ina.itype
				from view_ina ina 
				left join view_inas inas on ina.noa=inas.noa
				where inas.uno=b.uno
			) d
			left join acomp e on a.cno=e.noa
			where (a.noa between @t_bno and @t_eno) and (len(@t_stype) = 0 or a.stype = @t_stype)
	end
	else if(@t_merga = '1')
	begin
		insert into @tmp
			select
				'0',
				ROW_NUMBER()over(partition by a.noa order by a.noa)idno
				,a.cno cno,e.acomp acomp,e.addr aaddr,e.tel atel,e.fax afax
				,1 ordeno,a.kind,a.stype,a.noa,a.typea,a.datea,a.custno,a.comp,a.tel,(case when a.addr2!='' then a.post2+a.addr2 else a.post+a.addr end),a.cardeal,a.carno,a.memo,
				a.money,
				case when @checkUcca>0 then 0 else isnull(a.tax,0) end,
				a.total,b.ordeno+(case when isnull(d.itype,'')='3' then '寄庫' else '' end),'',b.spec,case when charindex(left(max(uno),1),'XYZ') > 0 then  (case when len(b.product) > 0 then b.product else '廢料' end) else b.product end ,
				(case when (b.style='' and b.dime='') then null else 
					(case @t_showtype when '1' then b.size when '2' then dbo.csize(a.kind,b.dime,b.width,b.lengthb,b.radius) else
					(case when ltrim(rtrim(isnull(b.size,'')))='' then dbo.csize(a.kind,b.dime,b.width,b.lengthb,b.radius) else b.size end) end )
				end) size,
				(case when ((b.style='' and b.dime='') and (charindex(left(b.uno,1),'XYZ') <= 0)) then null else sum(b.mount) end),
				(case when ((b.style='' and b.dime='') and (charindex(left(b.uno,1),'XYZ') <= 0) and (ltrim(rtrim(b.spec)) != '格外管')) then null else sum(b.weight) end),
				b.price,a.trantype
			from view_vcc a
			left join view_vccs b on a.noa = b.noa
			left join vcca c on a.invono=c.noa
			outer apply(
				select
					top 1 ina.itype
				from view_ina ina 
				left join view_inas inas on ina.noa=inas.noa
				where inas.uno=b.uno
			) d
			left join acomp e on a.cno=e.noa
			where (a.noa between @t_bno and @t_eno) and (len(@t_stype) = 0 or a.stype = @t_stype)
			group by case when isnull(d.itype,'')='3' then '寄庫' else '' end,b.ordeno,b.no2,a.kind,a.stype,a.noa,a.typea,a.datea,a.custno,a.comp,a.tel,a.post,a.addr,a.post2,a.addr2,a.cardeal,a.carno,
						a.memo,a.money,a.tax,a.total,b.spec,b.product,b.size,a.kind,b.dime,b.width,b.lengthb,b.radius,b.style,
						b.price,a.trantype,left(uno,1)
						,a.cno,e.acomp,e.addr,e.tel,e.fax
	/*
		update a
			set orderno = isnull((select max(noq) from view_vccs[1] where (a.noa = noa) and product = a.products),1)
		from @tmp a
	*/
	end
	if(@checkUcca>0)
	begin
		update @tmp set tax=isnull(c.tax,0)
		from @tmp a
		left join view_vcc b on a.noa=b.noa
		outer apply  (select sum(isnull(tax,0))  tax from vcca where noa=b.invono) c
	end


	declare @noa nvarchar(50)
	declare @count int
	declare @idno int
	declare @k int = 0 ----差幾頁
	declare @pageCount int
	declare @orderno int
	declare @pageno int
	declare cursor_table cursor for
		select noa,count(*),max(orderno) from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@count,@orderno
	while(@@FETCH_STATUS <> -1)
	begin		
		if(@count > @t_pageline)
		begin
			set @k = CEILING((cast(@count as float)/@t_pageline))
			while(@k > 0)
			begin
				update @tmp set pageno = @k where orderno > ((@k-1)*@t_pageline) and orderno <= (@k*@t_pageline)
				set @k -=1
			end
		end
		fetch next from cursor_table
		into @noa,@count,@orderno
	end
	close cursor_table
	deallocate cursor_table
	update @tmp set orderno = orderno-((pageno-1)*@t_pageline)
	declare cursor_table cursor for
		select distinct noa,max(orderno),pageno,min(idno),count(*) from @tmp group by noa,pageno
	open cursor_table
	fetch next from cursor_table
	into @noa,@orderno,@pageno,@idno,@count
	while(@@FETCH_STATUS <> -1)
	begin		
		set @k = @t_pageline -(@count%@t_pageline)
		set @pageCount = @count/@t_pageline
		if(@k < @t_pageline and (@pageCount =0))
		begin
			while(@k > 0)
			begin
				insert into @tmp(gno,cno,acomp,aaddr,atel,afax,orderno,pageno,noa,typea,trantype,memo,kind,stype,custno,custs,tax,money,total)
					select '0',cno,acomp,aaddr,atel,afax,(@orderno+1),@pageno,@noa,typea,trantype,memo,kind,stype,custno,custs,tax,money,total from @tmp where idno = @idno
				set @k = @k-1
				set @orderno = @orderno +1
			end
		end
		insert into @tmp(gno,cno,acomp,aaddr,atel,afax,orderno,pageno,noa,typea,trantype,kind,stype,custno,custs,tax,money,total,memo,mount,weight) 
			select '1',cno,acomp,aaddr,atel,afax,(@t_pageline+1),pageno,noa,typea,trantype,kind,stype,custno,custs,max(tax),max(money),max(total),memo,sum(mount),sum(weight) from @tmp where gno=0 and noa=@noa and pageno=@pageno group by noa,typea,trantype,pageno,kind,stype,custno,custs,tax,money,total,memo ,cno,acomp,aaddr,atel,afax
		insert into @tmp(gno,cno,acomp,aaddr,atel,afax,orderno,pageno,noa,typea,trantype,kind,stype,memo) 
			select '2',cno,acomp,aaddr,atel,afax,(@t_pageline+2),pageno,noa,typea,trantype,kind,stype,memo from @tmp where gno=0 and noa=@noa and pageno=@pageno group by noa,typea,trantype,pageno,kind,stype,memo,cno,acomp,aaddr,atel,afax
		fetch next from cursor_table
		into @noa,@orderno,@pageno,@idno,@count
	end
	close cursor_table
	deallocate cursor_table
	update @tmp set total = isnull(tax,0) + isnull(money,0) where gno = '1'
	if(@t_showprice = '0')
	begin
		update @tmp set tax = null,money = null,total = null,price = null
	end
	update @tmp set csize = replace(csize,'~#$','''')
	update @tmp set stype = (case stype when '1' then '買賣' when '2' then '加工' when '3' then '代工' end)
	select
		gno,idno
		,cno,acomp,aaddr,atel,afax
		,orderno,pageno,kind,noa,typea,datea,custno,custs,tel,addr,cardeal,carno,memo,stype,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) tax,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
		'&nbsp'+CHAR(59)+ordeno ordeno
		,case when len(uno)>11 then '' else uno end uno,spec,
		products,
		csize
		,case when len(products)>=4 then products+'&nbsp'+CHAR(59)+isnull(csize,'') else left(products+'　　　　',4)+'&nbsp'+CHAR(59)+isnull(csize,'') end xxx
		,cast(mount as nvarchar)+'&nbsp'+CHAR(59) mount,
		round(weight,0) weight,
		price,
		case when trantype='自取' then '' else 'V' end aa,
		case when trantype='自取' then 'V' else '' end bb,
		case when typea='2' then '退貨' else '' end isout
	from @tmp  order by noa desc,pageno,gno,orderno;